#include<avr/io.h>
#include<avr/interrupt.h>
#include<util/delay.h>
#include "lcd.h"
#include "gpio.h"
#include "keypad.h"
#include "common_macros.h"
#include "uart.h"
#include "timer.h"


#define ENTER_KEY 13
#define HMI_Ready 0xAC
#define CONTROL_Ready 0xCA
//void initialization (void);
uint8 g_matching_flag;
uint8 password_1[5];
uint8 password_2[5];
uint8 i;
uint8 g_option;
typedef enum {Unmatched,Matched}matchig_state;
/*******************************************************************************
 *                      Functions Prototypes                                   *
 *******************************************************************************/

void passwor_setting(void);
void main_options(void);



int main(void)
{

	UART_ConfigType UART_Configs={_8_bit,no_parity,_1_bit,9600};
	LCD_init();
	UART_init(&UART_Configs);
	passwor_setting();
	LCD_clearScreen();
while(1)
{



do{
	main_options();
	g_option=KEYPAD_getPressedKey();


}while(g_option!='+'&&!='+');

LCD_clearScreen();

}




}



void passwor_setting(void)
{

	do{



			LCD_displayStringRowColumn(0, 0, "PLZ Enter Pass:");
			LCD_moveCursor(1, 0);



	while(KEYPAD_getPressedKey()!=ENTER_KEY){

		for(i=0;i<5;i++)
		{
			password_1[i]=KEYPAD_getPressedKey();
			if(KEYPAD_getPressedKey()<=9 && KEYPAD_getPressedKey()>=0)
			{
			LCD_displayCharacter('*');
			_delay_ms(500);

			}

			else

			{
				i--;
			}


		}



	}

	LCD_clearScreen();
	LCD_displayStringRowColumn(0, 0, "PLZ Re_enter ");
	LCD_displayStringRowColumn(1, 0, "Pass:");

	//while(KEYPAD_getPressedKey()!=ENTER_KEY){

	for(i=0;i<5;i++)
	{
		password_2[i]=KEYPAD_getPressedKey();
		if(KEYPAD_getPressedKey()<=9 && KEYPAD_getPressedKey()>=0){
			LCD_displayCharacter('*');
			_delay_ms(500);

		}

		else
		{
			i--;
		}


	}
	//}

	//LCD_clearScreen();


	/*send password1  to control*/

	while(UART_recieveByte()!=CONTROL_Ready);
	for(i=0;i<5;i++)
	{

		UART_sendByte(password_1[i]);
		}



	while(UART_recieveByte()!=CONTROL_Ready);
		for(i=0;i<5;i++)
		{

			UART_sendByte(password_2[i]);
		}

		_delay_ms(10);

		matchig_state password_state;
		UART_sendByte(HMI_Ready);
		password_state=UART_recieveByte();

		LCD_clearScreen();

	if(password_state == Matched) /*flag that sent by CoNTrOl MC that indicates the state of the password*/
	{
			g_matching_flag=1;
			LCD_displayStringRowColumn(0, 4, "Matched");
			_delay_ms(500);

	}

	else{

			LCD_displayStringRowColumn(0, 4, "Unmatched");
			_delay_ms(500);

}


	}while(g_matching_flag==0);
}

void main_options(void)
{

LCD_displayStringRowColumn(0, 0,"+:Open Door");
LCD_displayStringRowColumn(1, 0,"-:Change Pass");
//return KEYPAD_getPressedKey();

}

